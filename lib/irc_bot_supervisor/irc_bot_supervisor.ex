defmodule TwitchIrc.IrcBotSupervisor do
  use DynamicSupervisor

  alias TwitchIrc.IrcBot.Config

  def start_link(_arg) do
    DynamicSupervisor.start_link(__MODULE__, nil, name: __MODULE__)
  end

  def start_child(%Config{} = config) do
    spec = {TwitchIrc.IrcBot, config}
    DynamicSupervisor.start_child(__MODULE__, spec)
  end

  def irc_bot_list() do
    DynamicSupervisor.which_children(__MODULE__)
    |> Enum.map(fn {:undefined, pid, :worker, [TwitchIrc.IrcBot]} ->
      TwitchIrc.IrcBot.irc_bot_info(pid)
    end)
  end

  def irc_bot_list_expiration() do
    DynamicSupervisor.which_children(__MODULE__)
    |> Enum.map(fn {:undefined, pid, :worker, [TwitchIrc.IrcBot]} ->
      name = elem(TwitchIrc.IrcBot.irc_bot_info(pid).name, 1)
      expiration = TwitchIrc.IrcBot.has_expired?(name)
      %{pid: pid, name: name, expiration: expiration}
    end)
  end

  def clean_expired_bots() do
    irc_bot_list_expiration()
    |> Enum.filter(fn bot ->
      bot.expiration
    end)
    |> Enum.map(fn bot ->
      Task.async(fn ->
        terminate_irc_bot(bot.pid)
      end)
    end)
    |> Enum.map(fn task ->
      Task.await(task)
    end)
  end

  def terminate_irc_bot(username) when is_bitstring(username) do
    case Registry.lookup(Registry.IrcBot, {TwitchIrc.IrcBot, username}) do
      [pid] -> terminate_irc_bot(pid)
      _ -> {:error, :not_found}
    end
  end

  def terminate_irc_bot(pid) when is_pid(pid) do
    DynamicSupervisor.terminate_child(__MODULE__, pid)
  end

  def start_children(config_list) when is_list(config_list) do
    config_list
    |> Enum.map(fn config ->
      Task.async(fn ->
        start_child(config)
      end)
    end)
    |> Enum.map(fn task ->
      Task.await(task)
    end)
  end

  def init(_arg) do
    DynamicSupervisor.init(strategy: :one_for_one)
  end

  # Debug function (remove when released), use to test channels
  def top_100() do
    [
      [
        "Method",
        "121649330"
      ],
      [
        "Squeezielive",
        "52130765"
      ],
      [
        "TimTheTatman",
        "36769016"
      ],
      [
        "Sco",
        "12665"
      ],
      [
        "alanzoka",
        "38244180"
      ],
      [
        "Greekgodx",
        "15310631"
      ],
      [
        "gaules",
        "181077473"
      ],
      [
        "Castro_1021",
        "52091823"
      ],
      [
        "CohhCarnage",
        "26610234"
      ],
      [
        "Nightblue3",
        "26946000"
      ],
      [
        "Stray228",
        "40488774"
      ],
      [
        "Rainbow6",
        "65171890"
      ],
      [
        "StarCraft",
        "42508152"
      ],
      [
        "forsen",
        "22484632"
      ],
      [
        "Arthas",
        "27115707"
      ],
      [
        "Mithrain",
        "79442833"
      ],
      [
        "MethodJosh",
        "31120350"
      ],
      [
        "hardgamechannel",
        "153353959"
      ],
      [
        "GingiTV",
        "28241419"
      ],
      [
        "chocoTaco",
        "69906737"
      ],
      [
        "NoWay4u_Sir",
        "85397463"
      ],
      [
        "Trymacs",
        "64342766"
      ],
      [
        "jovirone",
        "53256534"
      ],
      [
        "서새봄냥",
        "30904062"
      ],
      [
        "Solary",
        "174955366"
      ],
      [
        "DreadzTV",
        "31089858"
      ],
      [
        "TFBlade",
        "59308271"
      ],
      [
        "한동숙",
        "139470326"
      ],
      [
        "A_Seagull",
        "19070311"
      ],
      [
        "Symfuhny",
        "31688366"
      ],
      [
        "WePlayEsport_RU",
        "37711733"
      ],
      [
        "MidOne",
        "113257162"
      ],
      [
        "Giantwaffle",
        "22552479"
      ],
      [
        "Mongraal",
        "133705618"
      ],
      [
        "dafran",
        "41314239"
      ],
      [
        "AdmiralBahroo",
        "40972890"
      ],
      [
        "SolaryFortnite",
        "198506129"
      ],
      [
        "AdmiralBulldog",
        "30816637"
      ],
      [
        "Sardoche",
        "50795214"
      ],
      [
        "imaqtpie",
        "24991333"
      ],
      [
        "pilavpowa",
        "37550199"
      ],
      [
        "Elajjaz",
        "26921830"
      ],
      [
        "SypherPK",
        "32140000"
      ],
      [
        "Shlorox",
        "40784764"
      ],
      [
        "armatvhs",
        "142506321"
      ],
      [
        "72hrs",
        "101400190"
      ],
      [
        "C_a_k_e",
        "43899589"
      ],
      [
        "TeePee",
        "23844396"
      ],
      [
        "RTGameCrowd",
        "88547576"
      ],
      [
        "Shiphtur",
        "26560695"
      ],
      [
        "Lasqa",
        "60796327"
      ],
      [
        "Chap",
        "192678094"
      ],
      [
        "Amaz",
        "43356746"
      ],
      [
        "Quin69",
        "56649026"
      ],
      [
        "Trikslyr",
        "60900813"
      ],
      [
        "AdzTV",
        "170547313"
      ],
      [
        "ALOHADANCETV",
        "46571894"
      ],
      [
        "ElmiilloR",
        "44880944"
      ],
      [
        "QuickyBaby",
        "30623831"
      ],
      [
        "PietSmiet",
        "21991090"
      ],
      [
        "singsing",
        "21390470"
      ],
      [
        "따효니",
        "102381201"
      ],
      [
        "DomenicoWaccoo",
        "156203554"
      ],
      [
        "TheOnlyRyann",
        "62334719"
      ],
      [
        "WooxSolo",
        "50297139"
      ],
      [
        "ProfessorNoxLive",
        "43349612"
      ],
      [
        "BruceGrannec",
        "31813025"
      ],
      [
        "Levo",
        "71978007"
      ],
      [
        "HLTVorg",
        "20780251"
      ],
      [
        "HighDistortion",
        "84752541"
      ],
      [
        "MrSavageM",
        "198182340"
      ],
      [
        "AlphaCast",
        "94435040"
      ],
      [
        "pro_cast2",
        "148525388"
      ],
      [
        "uebermarginal",
        "94707429"
      ],
      [
        "H2P_Gucio",
        "36954803"
      ],
      [
        "uzra",
        "11692694"
      ],
      [
        "RoyalPhunk",
        "21431060"
      ],
      [
        "김나성",
        "103991968"
      ],
      [
        "1PVCS",
        "168116110"
      ],
      [
        "Laink",
        "89872865"
      ],
      [
        "Nick28T",
        "49303276"
      ],
      [
        "sertnqw334",
        "406606976"
      ],
      [
        "EWROON",
        "82197170"
      ],
      [
        "Gamepedia",
        "61355521"
      ],
      [
        "SkipNhO",
        "63602976"
      ],
      [
        "dasMEHDI",
        "31557869"
      ],
      [
        "knekro",
        "152633332"
      ],
      [
        "dinkotv",
        "160633569"
      ],
      [
        "Domingo",
        "40063341"
      ],
      [
        "resttpowered",
        "50063424"
      ],
      [
        "亞洲統神",
        "43177431"
      ],
      [
        "BladeandSoul",
        "87859239"
      ],
      [
        "CSRuHub",
        "116311210"
      ],
      [
        "Amouranth",
        "125387632"
      ],
      [
        "PersAnal",
        "264053254"
      ],
      [
        "flamuu",
        "63867913"
      ],
      [
        "WeAreTheVR",
        "63493039"
      ],
      [
        "MacieJay",
        "122320848"
      ],
      [
        "LeStream",
        "147337432"
      ],
      [
        "CarTmaNzbs",
        "50958896"
      ],
      [
        "CarTmaNzbs",
        "50958896"
      ],
      [
        "Fragnance",
        "25084072"
      ],
      [
        "bmkibler",
        "25871845"
      ],
      [
        "WELOVEGAMES",
        "30814134"
      ],
      [
        "Homyatol",
        "21167655"
      ],
      [
        "LVPes2",
        "42028083"
      ],
      [
        "Bonjwa",
        "73437396"
      ],
      [
        "allkeyshop_tv",
        "198461840"
      ],
      [
        "Yogscast",
        "20786541"
      ],
      [
        "nurseos",
        "26671723"
      ],
      [
        "CarcinogenSDA",
        "14891712"
      ],
      [
        "Kotton",
        "81463115"
      ],
      [
        "Agraelus",
        "36620767"
      ],
      [
        "illidanstr",
        "61952474"
      ],
      [
        "工商巨魔",
        "7995300"
      ],
      [
        "KarmikKoala",
        "54742538"
      ],
      [
        "CasinoDaddy",
        "121228500"
      ],
      [
        "BROBQ",
        "33149972"
      ],
      [
        "itmeJP",
        "10817445"
      ],
      [
        "ANGRYPUG",
        "63164470"
      ],
      [
        "MrBboy45",
        "21080562"
      ],
      [
        "웁_게임방송",
        "137753119"
      ],
      [
        "WeAreB0b",
        "89890241"
      ],
      [
        "Faux",
        "40980097"
      ],
      [
        "LeBouseuh",
        "96562014"
      ],
      [
        "Robbaz",
        "71336"
      ],
      [
        "LVPes3",
        "42028111"
      ],
      [
        "CyrusTWO",
        "41108115"
      ],
      [
        "ItsSlikeR",
        "39885827"
      ],
      [
        "BlackFIreIce",
        "43780497"
      ],
      [
        "nealdii",
        "200752961"
      ],
      [
        "inet_easy",
        "39387497"
      ],
      [
        "Smoke",
        "70880222"
      ],
      [
        "Cicciogamer89",
        "31987213"
      ],
      [
        "deco1tv",
        "48057752"
      ],
      [
        "fl0m",
        "25093116"
      ],
      [
        "MoMaN",
        "18887776"
      ],
      [
        "NumotTheNummy",
        "26302559"
      ],
      [
        "Strippin",
        "23179441"
      ],
      [
        "segall",
        "35856714"
      ],
      [
        "repazmois",
        "101020771"
      ],
      [
        "xerwo",
        "36930822"
      ],
      [
        "EscapeAoE",
        "140643881"
      ],
      [
        "esl_csgo_pl",
        "23675021"
      ],
      [
        "Wujaszek_Zadymeczka_",
        "157974595"
      ],
      [
        "Rainbow6FR",
        "232300705"
      ],
      [
        "六希夫",
        "16677765"
      ],
      [
        "ybicanoooobov",
        "68950614"
      ],
      [
        "Attrix",
        "63740412"
      ],
      [
        "살인마협회장",
        "127718836"
      ],
      [
        "makataO",
        "44057119"
      ],
      [
        "Mathil1",
        "25575995"
      ],
      [
        "Clym",
        "21045643"
      ],
      [
        "hashinshin",
        "29289159"
      ],
      [
        "CreativeMonkeyz",
        "64638702"
      ],
      [
        "TSM_Viss",
        "90020006"
      ],
      [
        "OgamingLoL",
        "71852533"
      ],
      [
        "has_play",
        "41343529"
      ],
      [
        "Shaunz",
        "43102846"
      ],
      [
        "GeneraL_HS_",
        "62651386"
      ],
      [
        "SCGTour",
        "22480377"
      ],
      [
        "Valle",
        "179597489"
      ],
      [
        "imls",
        "26513896"
      ],
      [
        "trausi",
        "16774915"
      ],
      [
        "Buehlero",
        "63357756"
      ],
      [
        "Maxalibur",
        "65948427"
      ],
      [
        "BreaK",
        "37851229"
      ],
      [
        "mrslotuhuntegrk",
        "413502742"
      ],
      [
        "Dyrus",
        "30080751"
      ],
      [
        "Moondye7",
        "35933008"
      ],
      [
        "Fifalize",
        "59800003"
      ],
      [
        "Chad",
        "51847140"
      ],
      [
        "KindaFunnyGames",
        "71031406"
      ],
      [
        "gnumme",
        "40022691"
      ],
      [
        "originhs",
        "71852853"
      ],
      [
        "LeFouBruiteur",
        "77456419"
      ],
      [
        "Leko",
        "30684909"
      ],
      [
        "PatoPapao",
        "35647075"
      ],
      [
        "puniogaming",
        "108632901"
      ],
      [
        "Valkyrae",
        "79615025"
      ],
      [
        "OgamingSC2",
        "71852806"
      ],
      [
        "boyMinORu",
        "118336478"
      ],
      [
        "Aspen",
        "147927227"
      ],
      [
        "theRealShooKon3",
        "41283727"
      ],
      [
        "Overpow",
        "8822303"
      ],
      [
        "RyuQuezacotl",
        "39392583"
      ],
      [
        "鳥屎",
        "7995530"
      ],
      [
        "Fuji720p",
        "42143654"
      ],
      [
        "CeMka7721",
        "118263259"
      ],
      [
        "Divi",
        "64949289"
      ],
      [
        "bibaboy",
        "39263242"
      ],
      [
        "A1taOda",
        "51435464"
      ],
      [
        "jamclub",
        "75962614"
      ],
      [
        "Mouzakrobat",
        "97903976"
      ],
      [
        "꽃빈",
        "164234001"
      ],
      [
        "FifaTargrean",
        "134039697"
      ],
      [
        "Cloud_805",
        "57003257"
      ],
      [
        "SoloRenektonOnly",
        "30227322"
      ],
      [
        "AdamKissAK",
        "66996733"
      ],
      [
        "SayNoToRage",
        "82635236"
      ],
      [
        "Kunshikitty",
        "111787808"
      ],
      [
        "SayNoToRage",
        "82635236"
      ],
      [
        "SparkofPhoenixTV",
        "36464115"
      ],
      [
        "ArQuel",
        "99681838"
      ],
      [
        "TacolineTV",
        "132793370"
      ],
      [
        "kev1nTV",
        "48919437"
      ],
      [
        "Katie",
        "58529158"
      ],
      [
        "龜狗",
        "48093884"
      ],
      [
        "실프_",
        "138009898"
      ],
      [
        "ProfessorBroman",
        "39158791"
      ],
      [
        "AmarCODTV",
        "67931625"
      ],
      [
        "AnniTheDuck",
        "126884070"
      ],
      [
        "xmaystrooo",
        "250040951"
      ],
      [
        "Sloot",
        "29363507"
      ],
      [
        "NymN",
        "62300805"
      ],
      [
        "Kubon_",
        "28572093"
      ],
      [
        "AlaraShade",
        "57796979"
      ],
      [
        "Anti_SabaPing",
        "413203306"
      ],
      [
        "Sir_Thomas_",
        "71619324"
      ],
      [
        "Tinkerleo",
        "71968056"
      ],
      [
        "pe3ak888",
        "147836962"
      ],
      [
        "MeepoHa3ap",
        "85674261"
      ],
      [
        "MitchManCasting",
        "69817289"
      ],
      [
        "Nsoo7y",
        "86454396"
      ],
      [
        "Linkus7",
        "36066935"
      ],
      [
        "RocketBeansTV",
        "47627824"
      ],
      [
        "skill4ltu",
        "110775952"
      ],
      [
        "qqwtv",
        "140014027"
      ],
      [
        "LudojopSitream",
        "413137879"
      ],
      [
        "TobinatorLP",
        "36811285"
      ],
      [
        "luke4316live",
        "43725651"
      ],
      [
        "Teuf",
        "119413137"
      ],
      [
        "Xop0",
        "41665974"
      ],
      [
        "Jamside",
        "101204178"
      ],
      [
        "shenryyr",
        "44173074"
      ],
      [
        "PsiSyn",
        "25924287"
      ],
      [
        "SirPumpkn",
        "158092433"
      ],
      [
        "BastiGHG",
        "38121996"
      ],
      [
        "FiraxisGames",
        "59291908"
      ],
      [
        "EEGDOTA",
        "79300924"
      ],
      [
        "modestal",
        "112619759"
      ],
      [
        "LobosJR",
        "28640725"
      ],
      [
        "Incon",
        "37047104"
      ],
      [
        "Rekinss",
        "96812687"
      ],
      [
        "Everyeyeit",
        "52160263"
      ],
      [
        "RockAlone",
        "29151663"
      ],
      [
        "Manyrin",
        "53999900"
      ],
      [
        "Lorgokz",
        "32912802"
      ],
      [
        "apored",
        "154723532"
      ],
      [
        "gabepeixe",
        "59799994"
      ],
      [
        "brkk",
        "178752007"
      ],
      [
        "WhiteyDude",
        "89816009"
      ],
      [
        "Draineo",
        "58383015"
      ],
      [
        "zorlaKOKA",
        "43045369"
      ],
      [
        "TheRunningManZ",
        "69824993"
      ],
      [
        "ESL_CSGO",
        "31239503"
      ],
      [
        "ViklunD",
        "39355685"
      ],
      [
        "win0001",
        "234244446"
      ],
      [
        "jvtv",
        "84934385"
      ],
      [
        "BibixHD",
        "35685209"
      ],
      [
        "nadmyre",
        "145287127"
      ],
      [
        "Kyrenis",
        "52693304"
      ],
      [
        "MattStaples",
        "78965512"
      ],
      [
        "Tonytubo",
        "104327501"
      ],
      [
        "rainbrain",
        "29923971"
      ],
      [
        "vika_karter",
        "115139051"
      ],
      [
        "카라멜_",
        "138033816"
      ],
      [
        "czesio_invi",
        "146818065"
      ],
      [
        "ClassyPax",
        "86796245"
      ],
      [
        "iTermosifoni",
        "85756815"
      ],
      [
        "Lapi",
        "44806759"
      ],
      [
        "MembTV",
        "2400710"
      ],
      [
        "QueenMico",
        "138983334"
      ],
      [
        "VGBootCamp",
        "9846758"
      ],
      [
        "csruhub2",
        "117167527"
      ],
      [
        "orangemorange",
        "95603047"
      ],
      [
        "Fortuna",
        "107803559"
      ],
      [
        "FURIAtv",
        "178500702"
      ],
      [
        "xnapycz",
        "27370971"
      ],
      [
        "tecoNe",
        "100630863"
      ],
      [
        "Sp4zie",
        "28565473"
      ],
      [
        "Mazarin1k",
        "27186524"
      ],
      [
        "WPMEzony",
        "101286926"
      ],
      [
        "JugiPelaa",
        "137098953"
      ],
      [
        "ZEON",
        "31921744"
      ],
      [
        "Distortion2",
        "36324138"
      ],
      [
        "Ruvelius",
        "76081690"
      ],
      [
        "Squirrel",
        "30196776"
      ],
      [
        "TCEC_Chess_TV",
        "180854563"
      ],
      [
        "TaKeTV",
        "30186974"
      ],
      [
        "BadeschlappenLP",
        "31011999"
      ],
      [
        "Pathra",
        "102936080"
      ],
      [
        "CowboyFN",
        "186356535"
      ],
      [
        "chistor_",
        "31050237"
      ],
      [
        "Drainerx",
        "27031399"
      ],
      [
        "Dakillzor",
        "25722719"
      ],
      [
        "TheTrueVanguard",
        "76888605"
      ],
      [
        "Rainbow6DE",
        "76457409"
      ],
      [
        "C4mlann",
        "54681827"
      ],
      [
        "SheisouTV",
        "118422060"
      ]
    ]
    |> Enum.map(fn(data) ->
      username = Enum.at(data, 0)
      user_id = String.to_integer(Enum.at(data, 1))

      TwitchIrc.IrcBot.Config.new("justinfan2", username, user_id, "")
    end)
  end
end
